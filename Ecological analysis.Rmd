---
title: "Diatom-based ecological multivariate analyses"
author: "Vélez-Agudelo Camilo"
date: "8/3/2022"
output:
  html_notebook:
    code_folding: "show"
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(vegan)
library(rioja)
library(ggplot2)
library(ggpubr)
library(kableExtra)
library(gridExtra)
library(rstatix)
```

# **Colorado River** #

## Loading Biological Data ##

This dataset contains diatom data of 15 modern surface sediments samples collected in the middle and lower basin of the Colora River, Patagonia.



```{r}
speciesRC <- readRDS("speciesRC.rds") ##Importing Diatom Data##
```

## Diatom diagram of common species ##

Remove diatom taxa where relative abundance is less than 4%

```{r}

## This code estimates the relative abundance of each diatom specie##
speciesRC.rel <- (decostand(
    speciesRC,
    "total",
    MARGIN = 1)
    ) * 100

speciesRC.rel2 <- colSums(speciesRC.rel) ##Calculate column sums

##Subset data keeping only diatom species with relative abundance greater than 4%##
speciesRC.red <- speciesRC.rel[, which(speciesRC.rel2 > 4)]

```

Cluster analyses of untransformed diatom data.

```{r Cluster.Analysis.RC, fig.align="center", fig.width=12, fig.height=6}

dis.brayRC <- vegdist(
    x = speciesRC.rel,
    method = "bray"
    )

clustRC <- chclust(
    dis.brayRC, 
    method = "coniss"
    )

par(mfrow=c(1,2))
plot(clustRC,labels = NULL)
bstick(clustRC, plot = TRUE)

```

```{r Diatom.Diagram.RC, fig.width=12}

colorRC <- c(
    rep("darkseagreen4", 3), 
    rep("gold2", 10), 
    rep("chocolate3", 2)
    )

y.scaleRC <- 1:15

p1 <- strat.plot(
    speciesRC.red,
    xLeft = 0.07,
    xRight = 1,
    yBottom = 0.05,
    yTop = 0.7,
    y.rev = T, 
    yvar = y.scaleRC, 
    y.tks = y.scaleRC, 
    scale.percent = T,
    plot.line = F,
    plot.bar = T,
    lwd.bar = 16,
    ylabel = "Sampling site",
    srt.xlabel = 45,
    xSpace = 0.005,
    wa.order = "bottomleft",
    x.pc.inc = 5,
    x.pc.lab = T,
    cex.ylabel = 1.5,
    cex.xlabel = 1,
    cex.yaxis = 0.8, 
    col.bar = colorRC,
    col.line = colorRC,
    clust = clustRC,
    tck = 5,
    tcl = 0.1,
    sep.bar = T,
    add.smooth = F,
    smooth.span = 0.1
    )

addClustZone(p1, clustRC, 4, col = "red")
```


# **Negro River** #

## Loading Biological Data ##

This dataset contains diatom data of 18 modern surface sediments samples collected in the middle and lower basin of the Negro River, Patagonia.


```{r}
speciesRN <- readRDS("speciesRN.rds") ##Importing Diatom Data##
```

## Diatom diagram of common species ##

Remove diatom taxa where relative abundance is less than 4%

```{r}

## This code estimates the relative abundance of each diatom specie##
speciesRN.rel <- (decostand(
    speciesRN,
    "total",
    MARGIN = 1)
    ) * 100

speciesRN.rel2 <- colSums(speciesRN.rel) ##Calculate column sums

##Subset data keeping only diatom species with relative abundance greater than 4%##
speciesRN.red <- speciesRN.rel[, which(speciesRN.rel2 > 4)]

```

Cluster analyses of untransformed diatom data.

```{r Cluster.Analysis.RN, fig.width=12, fig.height=6}

dis.brayRN <- vegdist(
    x = speciesRN.rel,
    method = "bray"
    )

clustRN <- chclust(
    dis.brayRN, 
    method = "coniss"
    )

par(mfrow = c(1, 2))
plot(clustRN,labels = NULL)
bstick(clustRN, plot = TRUE)
```

```{r Diatom.Diagram.RN, fig.width=12}

colorRN <- c(
    rep("darkseagreen4", 6), 
    rep("gold2", 6), 
    rep("chocolate3", 5),
    rep("blueviolet", 1)
    )

y.scaleRN <- 1:18

p2 <- strat.plot(
    speciesRN.red,
    xLeft = 0.07,
    xRight = 1,
    yBottom = 0.05,
    yTop = 0.7,
    y.rev = T, 
    yvar = y.scaleRN, 
    y.tks = y.scaleRN, 
    scale.percent = T,
    plot.line = F,
    plot.bar = T,
    lwd.bar = 16,
    ylabel = "Sampling site",
    srt.xlabel = 45,
    xSpace = 0.005,
    wa.order = "bottomleft",
    x.pc.inc = 5,
    x.pc.lab = T,
    cex.ylabel = 1.5,
    cex.xlabel = 1,
    cex.yaxis = 0.8, 
    col.bar = colorRN,
    col.line = colorRN,
    clust = clustRN,
    tck = 5,
    tcl = 0.1,
    sep.bar = T,
    add.smooth = F,
    smooth.span = 0.1
    )

addClustZone(p2, clustRN, 4, col = "red")
```


## Non-metric Multidimensional Scaling (NMDS) ##

Analyses based on the diatom composition from Negro River. Contour lines show a smoothed surface of the abundance relative of Staurosira binodis (a), Staurosira construens (b), Cocconeis placentula (c) and Cocconeis euglypta (d). Filled black circles represent the estimate abundance relative in each sampling site.

```{r NMDS.RN, results=FALSE, fig.align="center", fig.width=12, fig.height=8}
speciesRN.hel <- decostand(speciesRN, "hellinger") ##Transformation of the species data##

speciesRN.nmds <- metaMDS(speciesRN.hel, distance = "bray")

par(mfrow=c(2,2))
ordisurf(
  speciesRN.nmds, 
  speciesRN.red[, "Staurosira.contruens.var.binodis"], 
  main = "Staurosira binodis Relative Abundance",
  bubble = TRUE,
  pch = 16,
  col = "darkseagreen4",
  cex = 3,
  xlim = c(-0.8, 0.8),
  nlevels = 20,
  display = "sites",
  bg = "black"
  )
text(speciesRN.nmds,
     display = "sites", 
     cex=0.8
     )

ordisurf(
  speciesRN.nmds, 
  speciesRN.red[, "Staurosira.construens"], 
  main = "Staurosira construens Relative Abundance",
  bubble = TRUE,
  pch = 16,
  col = "darkseagreen4",
  cex = 3,
  nlevels = 20,
  display = "sites",
  bg = "black"
  )
text(speciesRN.nmds,
     display = "sites", 
     cex=0.8
     )

ordisurf(
  speciesRN.nmds, 
  speciesRN.red[, "Cocconeis.placentula"], 
  main = "Cocconeis placentula Relative Abundance",
  bubble = TRUE,
  pch = 16,
  col = "darkseagreen4",
  cex = 3,
  nlevels = 20,
  display = "sites",
  bg = "black"
  )
text(speciesRN.nmds,
     display = "sites", 
     cex=0.8
     )

ordisurf(
  speciesRN.nmds, 
  speciesRN.red[, "Cocconeis.euglypta"], 
  main = "Cocconeis euglypta Relative Abundance",
  bubble = TRUE,
  pch = 16,
  col = "darkseagreen4",
  cex = 3,
  nlevels = 20,
  display = "sites",
  bg = "black"
  )
text(speciesRN.nmds,
     display = "sites", 
     cex=0.8
     )

```


# **Chubut River** #

## Loading Biological Data ##

This dataset contains diatom data of 17 modern surface sediments samples collected at the middle and lower basin of the Chubut River, Patagonia.



```{r}
speciesCH <- readRDS("speciesCH.rds") ##Importing Diatom Data##

```

## Diatom diagram of common species ##

Remove diatom taxa where relative abundance is less than 4%

```{r}

## This code estimates the relative abundance of each diatom specie##
speciesCH.rel <- (decostand(
    speciesCH,
    "total",
    MARGIN = 1)
    ) * 100

speciesCH.rel2 <- colSums(speciesCH.rel) ##Calculate column sums

##Subset data keeping only diatom species with relative abundance greater than 4%##
speciesCH.red <- speciesCH.rel[, which(speciesCH.rel2 > 4)]

```

Cluster analyses of untransformed diatom data.

```{r Cluster.Analysis.CH, fig.width=12, fig.height=6}

dis.brayCH <- vegdist(
    x = speciesCH.rel,
    method = "bray"
    )

clustCH <- chclust(
    dis.brayCH, 
    method = "coniss"
    )

par(mfrow = c(1, 2))
plot(clustCH,labels = NULL)
bstick(clustCH, plot = TRUE)
```

```{r Diatom.Diagram.CH, fig.width=12}

colorCH <- c(
    rep("darkseagreen4", 5), 
    rep("gold2", 6), 
    rep("chocolate3", 4),
    rep("blueviolet", 1)
    )

y.scaleCH <- 1:16

p3 <- strat.plot(
    speciesCH.red,
    xLeft = 0.07,
    xRight = 1,
    yBottom = 0.05,
    yTop = 0.7,
    y.rev = T, 
    yvar = y.scaleCH, 
    y.tks = y.scaleCH, 
    scale.percent = T,
    plot.line = F,
    plot.bar = T,
    lwd.bar = 16,
    ylabel = "Sampling site",
    srt.xlabel = 45,
    xSpace = 0.005,
    wa.order = "bottomleft",
    x.pc.inc = 5,
    x.pc.lab = T,
    cex.ylabel = 1.5,
    cex.xlabel = 1,
    cex.yaxis = 0.8, 
    col.bar = colorCH,
    col.line = colorCH,
    clust = clustCH,
    tck = 5,
    tcl = 0.1,
    sep.bar = T,
    add.smooth = F,
    smooth.span = 0.1
    )

addClustZone(p3, clustCH, 4, col = "red")
```


## Non-metric Multidimensional Scaling (NMDS) ##

Analyses based on the diatom composition from Negro River. Contour lines show a smoothed surface of the abundance relative of Amphora affinis (a), Cocconeis placentula (b), Stephanodiscus agassizensis (c) and Cocconeis euglypta (d). Filled black circles represent the estimate abundance relative in each sampling site.

```{r NMDS.CH, results=FALSE, fig.align="center", fig.width=12, fig.height=8}
speciesCH.hel <- decostand(speciesCH, "hellinger") ##Transformation of the species data##

speciesCH.nmds <- metaMDS(speciesCH.hel, distance = "bray")

par(mfrow = c(2, 2))
ordisurf(
  speciesCH.nmds, 
  speciesCH.red[, "Amphora.affinis"], 
  main = "Amphora affinis Relative Abundance",
  bubble = TRUE,
  pch = 16,
  col = "darkseagreen4",
  cex = 3,
  nlevels = 20,
  display = "sites",
  bg = "black"
  )
text(speciesCH.nmds,
     display = "sites", 
     cex=0.8
     )

ordisurf(
  speciesCH.nmds, 
  speciesCH.red[, "Cocconeis.placentula"], 
  main = "Cocconeis placentula Relative Abundance",
  bubble = TRUE,
  pch = 16,
  col = "darkseagreen4",
  cex = 3,
  nlevels = 20,
  display = "sites",
  bg = "black"
  )
text(speciesCH.nmds,
     display = "sites", 
     cex=0.8
     )

ordisurf(
  speciesCH.nmds, 
  speciesCH.red[, "Stephanodiscus.agassizensis"], 
  main = "Stephanodiscus agassizensis Relative Abundance",
  bubble = TRUE,
  pch = 16,
  col = "darkseagreen4",
  cex = 3,
  nlevels = 20,
  display = "sites",
  bg = "black"
  )
text(speciesCH.nmds,
     display = "sites", 
     cex=0.8
     )

ordisurf(
  speciesCH.nmds, 
  speciesCH.red[, "Cocconeis.euglypta"], 
  main = "Cocconeis euglypta Relative Abundance",
  bubble = TRUE,
  pch = 16,
  col = "darkseagreen4",
  cex = 3,
  nlevels = 20,
  display = "sites",
  bg = "black"
  )
text(speciesCH.nmds,
     display = "sites", 
     cex=0.8
     )

```



# **Redundancy Analysis (RDA)** #

Two RDAs were performed, one with the complete dataset (49 sampling sites)
and one with the reduced data. The estuarine sites were excluded of the analysis in the last dataset, so as to identify correlations among variables and diatom species only in freshwater sites. In addition, winter and summer values of physical and hidrochemical variables were averaged before performing these ordinations.

##Preparation of Biological and Environmental Data##

```{r data.transformed}
##Transformation of diatom data##
speciesRC.red.hel <- decostand(speciesRC.red, "hellinger")
speciesRN.red.hel <- decostand(speciesRN.red, "hellinger")
speciesCH.red.hel <- decostand(speciesRN.red, "hellinger")
```

```{r colnames.changed}
##Code assignment##

colnames(speciesRC.red.hel) <- names[[1]][, 2]
colnames(speciesRN.red.hel) <- names[[2]][, 2]
colnames(speciesCH.red.hel) <- names[[3]][, 2]
```

```{r loading.env}
##Loading Environmental Data##
varam <- readRDS("varam.rds")

##Physical and hydrochemical data##
chem <- varam[, 1:14]

##Sedimentological data#
sed <- varam[, 15:17]
```

##Selection of Explanatory Variables##

Preliminary CCA with forward selection based on permutation test (999 permutations, p < 0.05), was then used as an appropriate procedure to
identify collinear variables, to reduce the number of explanatory variables and thus establishing a minimal data set that significantly improves the quality of the diatom–environment model

```{r}

```









